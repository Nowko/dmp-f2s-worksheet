<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DMP — 욕망 해소 자금 산출 워크시트</title>
  <style>
    :root{
      --bg:#0b1020; --card:#131a33; --muted:#9fb0ff; --text:#e9edff;
      --accent:#7ea7ff; --danger:#ff7e7e; --ok:#7effb6; --border:rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR','Malgun Gothic',Arial,sans-serif; }
    body{ margin:0; background:linear-gradient(180deg,#0b1020,#0b1020 50%,#0f1530); color:var(--text); }

    .wrap{ max-width:980px; margin:40px auto; padding:0 16px; }
    .title{ font-size:28px; font-weight:800; letter-spacing:-.3px; margin-bottom:4px; }
    .subtitle{ color:var(--muted); margin-bottom:24px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
      margin-bottom:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }

    /* 두 컬럼 섹션 */
    .grid{
      display:grid;
      grid-template-columns:minmax(300px,1fr) minmax(300px,1fr);
      column-gap:24px; row-gap:12px;
    }

    /* 라벨-값-단위 한 줄을 우측으로 밀착 */
    .row{
      display:flex; align-items:center; justify-content:flex-end;
      gap:6px; margin:8px 0; width:100%;
    }
    .row > label{
      color:#c9d4ff; font-size:14px; text-align:right; white-space:nowrap;
      margin-right:6px;
    }
    .k{ margin-left:4px; white-space:nowrap; opacity:.95; }

    input[type="number"], input[readonly], input.result{
      width:110px; padding:7px 10px; text-align:right; font-variant-numeric:tabular-nums;
      border-radius:10px; border:1px solid var(--border);
      background:rgba(255,255,255,.05); color:var(--text); outline:none;
    }
    input::placeholder{ color:#93a3ff; opacity:.6; }

    /* 입력칸 vs 결과칸 색 구분 */
    input[type="number"]:not([readonly]){
      background:rgba(126,167,255,.10); border-color:rgba(126,167,255,.45);
    }
    input[type="number"]:not([readonly]):focus{
      outline:2px solid var(--accent);
      box-shadow:0 0 0 4px rgba(126,167,255,.15);
    }
    input[readonly]{
      background:rgba(126,255,182,.10); border-color:rgba(126,255,182,.45); cursor:default;
    }
    input[readonly]:focus{ outline:2px solid var(--ok); box-shadow:0 0 0 4px rgba(126,255,182,.15); }
    input.result{ width:120px; }

    select{
      width:120px; padding:7px 10px; border-radius:10px;
      border:1px solid rgba(126,167,255,.45); background:rgba(126,167,255,.10); color:var(--text);
      outline:none;
    }

    .section-title{ font-weight:800; margin-bottom:8px; font-size:18px; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:rgba(126,167,255,.12); color:var(--accent); font-weight:700; font-size:12px; margin-left:8px; }
    .result{ font-size:20px; font-weight:800; }
    .result.ok{ color:var(--ok); } .result.warn{ color:var(--danger); }
    .hint{ color:#92a1ff; font-size:12px; } .muted{ color:#b7c4ff; opacity:.8; font-size:14px; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{ background:linear-gradient(180deg,#2a3a7d,#24336b); border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; }
    button.secondary{ background:rgba(255,255,255,.05); } button.danger{ background:linear-gradient(180deg,#7d2a2a,#6b2424); }

    .footer{ opacity:.75; font-size:12px; margin-top:8px; }
    .hr{ border-top:1px dashed rgba(255,255,255,.15); margin:14px 0; }
    .note{ background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:13px; color:#cdd6ff; }

    /* 긴 라벨(설명식)은 좌측, 값은 우측 */
    .row.longlabel{ justify-content:space-between; }

    @media (max-width:760px){
      .grid{ grid-template-columns:1fr; column-gap:0; row-gap:10px; }
      input[type="number"], input[readonly]{ width:100px; }
      input.result{ width:110px; } select{ width:110px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">〈욕망 해소 자금 산출 워크시트〉</div>
    <div class="subtitle">현금흐름(3장) + 자산구조(4장)를 겹쳐, <b>안심하고 쓸 수 있는 월 금액(Free to Spend)</b>을 구합니다.</div>

    <!-- 1단계 -->
    <div class="card">
      <div class="section-title">1단계: 현금흐름 <span class="pill">F2S</span></div>
      <div class="row"><label>세후 소득</label><input type="number" step="0.1" min="0" id="income" placeholder="예: 280" /><div class="k">만원/월</div></div>

      <div class="hr"></div><div class="muted"><b>필수 생활비</b></div>
      <div class="grid">
        <div class="row"><label>주거비</label><input type="number" step="0.1" min="0" id="rent" placeholder="예: 70"/><div class="k">만원</div></div>
        <div class="row"><label>교통비</label><input type="number" step="0.1" min="0" id="transport" placeholder="예: 15"/><div class="k">만원</div></div>
        <div class="row"><label>식비(최소 필요)</label><input type="number" step="0.1" min="0" id="food" placeholder="예: 50"/><div class="k">만원</div></div>
        <div class="row"><label>통신비+보험료</label><input type="number" step="0.1" min="0" id="telIns" placeholder="예: 20"/><div class="k">만원</div></div>
        <div class="row"><label>기타 고정비(공과금 등)</label><input type="number" step="0.1" min="0" id="others" placeholder="예: 25"/><div class="k">만원</div></div>
      </div>
      <div class="row"><label class="hint">필수 생활비 합계</label><input type="number" id="mustSum" readonly /><div class="k">만원</div></div>

      <div class="hr"></div><div class="muted"><b>안전망 지출</b></div>
      <div class="grid">
        <div class="row"><label>비상자금 적립</label><input type="number" step="0.1" min="0" id="emFund" placeholder="예: 30"/><div class="k">만원</div></div>
        <div class="row"><label>부채 상환(원리금)</label><input type="number" step="0.1" min="0" id="debtPay" placeholder="예: 25"/><div class="k">만원</div></div>
        <div class="row"><label>최소 미래 저축</label><input type="number" step="0.1" min="0" id="futureSav" placeholder="예: 0~40"/><div class="k">만원</div></div>
      </div>
      <div class="row"><label class="hint">안전망 지출 합계</label><input type="number" id="safetySum" readonly /><div class="k">만원</div></div>

      <div class="hr"></div>
      <div class="row longlabel"><label class="result">F2S-흐름 = 세후 소득 − (필수 + 안전망)</label><input class="result" id="flowF2S" readonly /><div class="k result">만원/월</div></div>
      <div class="note">※ F2S-흐름은 “기본 한도”입니다. 다음 단계에서 자산 구조로 <b>보정</b>합니다.</div>
    </div>

    <!-- 2단계 -->
    <div class="card">
      <div class="section-title">2단계: 자산 구조 <span class="pill">BS-보정</span></div>

      <div class="muted"><b>현금성 자산 보정</b></div>
      <div class="grid">
        <div class="row"><label>현금성 자산 총액</label><input type="number" step="0.1" min="0" id="cashAssets" placeholder="예: 800"/><div class="k">만원</div></div>
        <div class="row"><label>비상자금 목표(개월)</label><input type="number" step="1" min="3" max="12" id="emMonths" value="6"/><div class="k">개월</div></div>
        <div class="row"><label>현금성 반영률</label><input type="number" step="5" min="0" max="100" id="cashRate" value="50"/><div class="k">%</div></div>
        <div class="row"><label>보호기간(초과 현금 분할기간)</label><input type="number" step="1" min="6" max="24" id="spreadMonths" value="12"/><div class="k">개월</div></div>
      </div>
      <div class="row"><label class="hint">적정 비상자금(필수 생활비 합계 × 목표 개월)</label><input type="number" id="needEmergency" readonly /><div class="k">만원</div></div>
      <div class="row"><label class="hint">초과 현금성 자산 (0 미만이면 0으로 처리)</label><input type="number" id="excessCash" readonly /><div class="k">만원</div></div>
      <div class="row"><label class="hint">현금성 보정(월 가산) = 초과×반영률÷보호기간</label><input type="number" id="cashAdj" readonly /><div class="k">만원/월</div></div>

      <div class="hr"></div>
      <div class="muted"><b>보존성 자산 보정</b></div>
      <div class="grid">
        <div class="row"><label>6개월 내 만기 금액</label><input type="number" step="0.1" min="0" id="preserveMature" placeholder="예: 120"/><div class="k">만원</div></div>
        <div class="row"><label>전환 반영률</label><input type="number" step="5" min="0" max="100" id="preserveRate" value="25"/><div class="k">%</div></div>
        <div class="row"><label>전환 분할기간</label><input type="number" step="1" min="3" max="24" id="preserveSpread" value="6"/><div class="k">개월</div></div>
      </div>
      <div class="row"><label class="hint">보존성 보정(월 가산) = 만기×전환율÷분할기간</label><input type="number" id="preserveAdj" readonly /><div class="k">만원/월</div></div>

      <div class="hr"></div>
      <div class="muted"><b>권장 전환률(자동)</b> <span class="hint">체크리스트 기반으로 0~50%에서 제안합니다.</span></div>
      <div class="grid">
        <div class="row"><label>목적자금(1년 내 사용)</label><input type="checkbox" id="earmark"/><div class="k"></div></div>
        <div class="row"><label>소득 안정성</label>
          <select id="incomeStability">
            <option value="stable">안정적</option>
            <option value="normal" selected>보통</option>
            <option value="volatile">변동 큼</option>
          </select><div class="k"></div>
        </div>
        <div class="row"><label>만기 3개월 이내</label><input type="checkbox" id="maturitySoon"/><div class="k"></div></div>
        <div class="row"><label>중도해지/수수료 손실</label>
          <select id="penaltyRisk">
            <option value="none" selected>거의 없음</option>
            <option value="some">보통</option>
            <option value="high">손실 큼</option>
          </select><div class="k"></div>
        </div>
        <div class="row"><label>6개월 내 큰 고정지출</label><input type="checkbox" id="bigExpense"/><div class="k"></div></div>
      </div>
      <div class="row"><label class="hint">권장 전환률(자동 계산)</label><input type="number" id="suggestedRate" readonly /><div class="k">%</div></div>
      <div class="btns"><button id="applySuggested" class="secondary">권장치 적용</button></div>

      <div class="hr"></div>
      <div class="row longlabel"><label class="result">BS-보정 합계 = 현금성(월) + 보존성(월) − 증가한 상환액(+일 때 차감)</label><input class="result" id="bsAdj" readonly /><div class="k result">만원/월</div></div>
      <div class="note">※ 성장성 자산은 원칙적으로 보정에 반영하지 않습니다.</div>
    </div>

    <!-- 최종 -->
    <div class="card">
      <div class="section-title">최종 결과</div>
      <div class="row longlabel"><label class="result">최종 욕망 해소 자금(월) = F2S-흐름 + BS-보정</label><input class="result" id="finalF2S" readonly /><div class="k result">만원/월</div></div>
      <div id="message" class="note" style="margin-top:10px;"></div>
      <div class="btns" style="margin-top:14px;">
        <button id="save">로컬 저장</button>
        <button class="secondary" id="load">불러오기</button>
        <button class="secondary" id="reset">초기화</button>
        <button class="secondary" id="exportCsv">TSV 내보내기</button>
      </div>
      <div class="footer">※ 저장은 이 브라우저(로컬스토리지)에만 보관됩니다.</div>
    </div>

    <div class="footer">© DMP — Default Money Plan. 이 도구는 정보 제공 목적이며, 개인 상황에 따라 결과가 달라질 수 있습니다.</div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const n = (v) => (isFinite(parseFloat(v)) ? parseFloat(v) : 0);
  const r1 = (v) => (Math.round((v ?? 0) * 10) / 10).toFixed(1);
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const has = (id) => !!$(id);

  // 1단계 계산
  function calcStep1() {
    const income = n($('income')?.value);

    const must =
      n($('rent')?.value) +
      n($('transport')?.value) +
      n($('food')?.value) +
      n($('telIns')?.value) +
      n($('others')?.value);

    const safety =
      n($('emFund')?.value) +
      n($('debtPay')?.value) +
      n($('futureSav')?.value);

    if (has('mustSum')) $('mustSum').value = r1(must);
    if (has('safetySum')) $('safetySum').value = r1(safety);
    if (has('flowF2S')) $('flowF2S').value = r1(income - must - safety);

    return { income, must, safety, flow: income - must - safety };
  }

  // 2단계 계산(있을 때만)
  function calcStep2(must) {
    if (!has('cashAssets')) return { bsAdj: 0, final: null };

    const cashAssets = n($('cashAssets')?.value);
    const emMonths = clamp(n($('emMonths')?.value ?? 6), 3, 12);
    if (has('emMonths')) $('emMonths').value = emMonths;

    const needEmergency = must * emMonths;
    if (has('needEmergency')) $('needEmergency').value = r1(needEmergency);

    const excess = Math.max(0, cashAssets - needEmergency);
    if (has('excessCash')) $('excessCash').value = r1(excess);

    const cashRate = clamp(n($('cashRate')?.value ?? 50), 0, 100);
    if (has('cashRate')) $('cashRate').value = cashRate;
    const spreadMonths = clamp(n($('spreadMonths')?.value ?? 12), 6, 24);
    if (has('spreadMonths')) $('spreadMonths').value = spreadMonths;

    const cashAdj = (excess * (cashRate / 100)) / (spreadMonths || 1);
    if (has('cashAdj')) $('cashAdj').value = r1(cashAdj);

    const preserveMature = n($('preserveMature')?.value);
    const preserveRate = clamp(n($('preserveRate')?.value ?? 25), 0, 100);
    if (has('preserveRate')) $('preserveRate').value = preserveRate;
    const preserveSpread = clamp(n($('preserveSpread')?.value ?? 6), 3, 24);
    if (has('preserveSpread')) $('preserveSpread').value = preserveSpread;

    const preserveAdj =
      (preserveMature * (preserveRate / 100)) / (preserveSpread || 1);
    if (has('preserveAdj')) $('preserveAdj').value = r1(preserveAdj);

    // 부채 보정 입력칸이 없어도 0으로 처리
    const debtDelta = n($('debtDelta')?.value ?? 0);

    const bsAdj = cashAdj + preserveAdj - Math.max(0, debtDelta) + Math.min(0, debtDelta);
    if (has('bsAdj')) $('bsAdj').value = r1(bsAdj);

    return { bsAdj };
  }

  function calcAll() {
    const s1 = calcStep1();
    const s2 = calcStep2(s1.must);
    if (has('finalF2S')) $('finalF2S').value = r1((s1.flow ?? 0) + (s2.bsAdj ?? 0));

    // 안내 문구(선택)
    if ($('message')) {
      const msg = [];
      if (has('excessCash') && n($('excessCash').value) <= 0)
        msg.push('현금성 자산이 비상자금 목표에 미달하여 현금성 보정 가산이 없습니다.');
      if (has('preserveAdj') && n($('preserveAdj').value) > 0)
        msg.push('보존성 만기금 일부를 기간에 나눠 반영 중입니다.');
      $('message').textContent = msg.join(' ') || '계산이 완료되었습니다.';
    }
  }

  // 초기 예제값 주입(빈 칸일 때만)
  function setDefaults() {
    const defaults = {
      // 1단계
      income: 280, rent: 70, transport: 15, food: 50, telIns: 20, others: 25,
      emFund: 30, debtPay: 25, futureSav: 40,
      // 2단계(있으면)
      cashAssets: 800, emMonths: 6, cashRate: 50, spreadMonths: 12,
      preserveMature: 0, preserveRate: 25, preserveSpread: 6,
      debtDelta: 0
    };
    Object.entries(defaults).forEach(([id, val]) => {
      if ($(id) && ($(id).value === '' || $(id).value == null)) $(id).value = val;
    });
  }

  // 입력 감지 → 실시간 계산
  function wireInputs() {
    const ids = [
      'income','rent','transport','food','telIns','others',
      'emFund','debtPay','futureSav',
      'cashAssets','emMonths','cashRate','spreadMonths',
      'preserveMature','preserveRate','preserveSpread','debtDelta'
    ];
    ids.forEach(id => $(id)?.addEventListener('input', calcAll));
  }

  window.addEventListener('DOMContentLoaded', () => {
    setDefaults();
    wireInputs();
    calcAll(); // 처음에도 결과칸 채우기
  });
})();
</script>

</body>
</html>
