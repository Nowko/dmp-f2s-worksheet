<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DMP — 욕망 해소 자금 산출 워크시트</title>
  <style>
    /* ===== Theme ===== */
    :root{
      --bg:#0b1020; --card:#131a33; --muted:#9fb0ff; --text:#e9edff;
      --accent:#7ea7ff; --danger:#ff7e7e; --ok:#7effb6; --border:rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR','Malgun Gothic',Arial,sans-serif; }
    body{ margin:0; background:linear-gradient(180deg,#0b1020,#0b1020 50%,#0f1530); color:var(--text); }

    /* ===== Layout ===== */
    .wrap{ max-width:980px; margin:40px auto; padding:0 16px; }
    .title{ font-size:28px; font-weight:800; letter-spacing:-.3px; margin-bottom:4px; }
    .subtitle{ color:var(--muted); margin-bottom:24px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
      margin-bottom:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }

    /* 좌/우 두 칸(열) */
    .grid{
      display:grid;
      grid-template-columns:minmax(300px,1fr) minmax(300px,1fr);
      column-gap:24px;
      row-gap:12px;
    }

    /* 한 줄: [라벨 | 입력 | 단위]  → 값 블록을 '칸의 우측'에 붙임 */
    .row{
      display:flex;
      align-items:center;
      justify-content:flex-end;   /* ← 값 블록을 칸의 우측으로 붙임 */
      gap:6px;                    /* 라벨↔입력, 입력↔단위 간격 */
      margin:8px 0;
      width:100%;
    } 
    .row > label{
      color:#c9d4ff; font-size:14px;
      text-align:right;           /* 라벨 우측 정렬 → 입력 직전까지 붙음 */
      white-space:nowrap;         /* 줄바꿈 방지 */
      margin-right:6px;           /* 라벨과 입력 간 살짝 간격 */
    }

    /* 숫자 입력/결과 */
    input[type="number"], input[readonly], input.result{
      width:110px;               /* 100~130px 사이로 조정 가능 */
      padding:7px 10px;
      text-align:right;          /* 숫자 우측 정렬 */
      font-variant-numeric: tabular-nums;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      outline:none;
    }
    input::placeholder{ color:#93a3ff; opacity:.6; }

    /* 선택박스(셀렉트) 동일 스타일 */
    select{
      width:120px;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid rgba(126,167,255,.45);
      background:rgba(126,167,255,.10);
      color:var(--text);
      outline:none;
    }

    /* 단위 텍스트 */
    .k{ margin-left:4px; white-space:nowrap; opacity:.95; } /* 단위는 입력 바로 옆 */
    
    /* 결과 라인(긴 라벨) */
    input.result{ width:120px; }

    /* 입력칸 vs 결과칸 시각 구분 */
    input[type="number"]:not([readonly]) {
      background: rgba(126,167,255,.10);
      border-color: rgba(126,167,255,.45);
    }
    input[type="number"]:not([readonly]):focus {
      outline: 2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(126,167,255,.15);
    }
    input[readonly]{
      background: rgba(126,255,182,.10);
      border-color: rgba(126,255,182,.45);
      cursor: default;
    }
    input[readonly]:focus{
      outline: 2px solid var(--ok);
      box-shadow: 0 0 0 4px rgba(126,255,182,.15);
    }
    input[type="number"]:not([readonly])::placeholder { color:#a9bbff; }
    input[readonly]::placeholder { color:#b7ffd9; }

    /* 자잘한 요소 */
    .section-title{ font-weight:800; margin-bottom:8px; font-size:18px; }
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      background:rgba(126,167,255,.12); color:var(--accent);
      font-weight:700; font-size:12px; margin-left:8px;
    }
    .result{ font-size:20px; font-weight:800; }
    .result.ok{ color:var(--ok); }
    .result.warn{ color:var(--danger); }
    .hint{ color:#92a1ff; font-size:12px; }
    .muted{ color:#b7c4ff; opacity:.8; font-size:14px; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      background:linear-gradient(180deg,#2a3a7d,#24336b);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
    }
    button.secondary{ background:rgba(255,255,255,.05); }
    button.danger{ background:linear-gradient(180deg,#7d2a2a,#6b2424); }

    .footer{ opacity:.75; font-size:12px; margin-top:8px; }
    .hr{ border-top:1px dashed rgba(255,255,255,.15); margin:14px 0; }
    .note{
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      color:#cdd6ff;
    }

    /* Responsive */
    @media (max-width:760px){
      .grid{ grid-template-columns:1fr; column-gap:0; row-gap:10px; }
      input[type="number"], input[readonly]{ width:100px; }
      input.result{ width:110px; }
      select{ width:110px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">〈욕망 해소 자금 산출 워크시트〉</div>
    <div class="subtitle">현금흐름(3장) + 자산구조(4장)를 겹쳐, <b>안심하고 쓸 수 있는 월 금액(Free to Spend)</b>을 구합니다.</div>

    <!-- 1단계: 현금흐름 -->
    <div class="card">
      <div class="section-title">1단계: 현금흐름 <span class="pill">F2S</span></div>

      <div class="row"><label>세후 소득</label><input type="number" step="0.1" min="0" id="income" placeholder="예: 280" /><div class="k">만원/월</div></div>

      <div class="hr"></div>
      <div class="muted"><b>필수 생활비</b></div>

      <div class="grid">
        <div class="row"><label>주거비</label><input type="number" step="0.1" min="0" id="rent" placeholder="예: 70"/><div class="k">만원</div></div>
        <div class="row"><label>교통비</label><input type="number" step="0.1" min="0" id="transport" placeholder="예: 15"/><div class="k">만원</div></div>
        <div class="row"><label>식비(최소 필요)</label><input type="number" step="0.1" min="0" id="food" placeholder="예: 50"/><div class="k">만원</div></div>
        <div class="row"><label>통신비+보험료</label><input type="number" step="0.1" min="0" id="telIns" placeholder="예: 20"/><div class="k">만원</div></div>
        <div class="row"><label>기타 고정비(공과금 등)</label><input type="number" step="0.1" min="0" id="others" placeholder="예: 25"/><div class="k">만원</div></div>
      </div>

      <div class="row"><label class="hint">필수 생활비 합계</label><input type="number" id="mustSum" readonly /><div class="k">만원</div></div>

      <div class="hr"></div>
      <div class="muted"><b>안전망 지출</b></div>

      <div class="grid">
        <div class="row"><label>비상자금 적립</label><input type="number" step="0.1" min="0" id="emFund" placeholder="예: 30"/><div class="k">만원</div></div>
        <div class="row"><label>부채 상환(원리금)</label><input type="number" step="0.1" min="0" id="debtPay" placeholder="예: 25"/><div class="k">만원</div></div>
        <div class="row"><label>최소 미래 저축</label><input type="number" step="0.1" min="0" id="futureSav" placeholder="예: 0~40"/><div class="k">만원</div></div>
      </div>

      <div class="row"><label class="hint">안전망 지출 합계</label><input type="number" id="safetySum" readonly /><div class="k">만원</div></div>

      <div class="hr"></div>

      <div class="row"><label class="result">F2S-흐름 = 세후 소득 − (필수 + 안전망)</label><input class="result" id="flowF2S" readonly /><div class="k result">만원/월</div></div>
      <div class="note">※ F2S-흐름은 “기본 한도”입니다. 다음 단계에서 자산 구조로 <b>보정</b>합니다.</div>
    </div>

    <!-- 2단계: 자산 구조 보정 -->
    <div class="card">
      <div class="section-title">2단계: 자산 구조 <span class="pill">BS-보정</span></div>

      <div class="muted"><b>현금성 자산 보정</b></div>
      <div class="grid">
        <div class="row"><label>현금성 자산 총액</label><input type="number" step="0.1" min="0" id="cashAssets" placeholder="예: 800"/><div class="k">만원</div></div>
        <div class="row"><label>비상자금 목표(개월)</label><input type="number" step="1" min="3" max="12" id="emMonths" value="6"/><div class="k">개월</div></div>
        <div class="row"><label>현금성 반영률</label><input type="number" step="5" min="0" max="100" id="cashRate" value="50"/><div class="k">%</div></div>
        <div class="row"><label>보호기간(초과 현금 분할기간)</label><input type="number" step="1" min="6" max="24" id="spreadMonths" value="12"/><div class="k">개월</div></div>
      </div>
      <div class="row"><label class="hint">적정 비상자금(필수 생활비 합계 × 목표 개월)</label><input type="number" id="needEmergency" readonly /><div class="k">만원</div></div>
      <div class="row"><label class="hint">초과 현금성 자산 (0 미만이면 0으로 처리)</label><input type="number" id="excessCash" readonly /><div class="k">만원</div></div>
      <div class="row"><label class="hint">현금성 보정(월 가산) = 초과×반영률÷보호기간</label><input type="number" id="cashAdj" readonly /><div class="k">만원/월</div></div>

      <div class="hr"></div>
      <div class="muted"><b>보존성 자산 보정</b></div>
      <div class="grid">
        <div class="row"><label>6개월 내 만기 금액</label><input type="number" step="0.1" min="0" id="preserveMature" placeholder="예: 120"/><div class="k">만원</div></div>
        <div class="row"><label>전환 반영률</label><input type="number" step="5" min="0" max="100" id="preserveRate" value="25"/><div class="k">%</div></div>
        <div class="row"><label>전환 분할기간</label><input type="number" step="1" min="3" max="24" id="preserveSpread" value="6"/><div class="k">개월</div></div>
      </div>
      <div class="row"><label class="hint">보존성 보정(월 가산) = 만기×전환율÷분할기간</label><input type="number" id="preserveAdj" readonly /><div class="k">만원/월</div></div>

      <!-- === 권장 전환률(자동 제안) UI === -->
      <div class="hr"></div>
      <div class="muted"><b>권장 전환률(자동)</b> <span class="hint">체크리스트 기반으로 0~50%에서 제안합니다.</span></div>
      <div class="grid">
        <div class="row"><label>목적자금(1년 내 사용)</label><input type="checkbox" id="earmark"/><div class="k"></div></div>
        <div class="row"><label>소득 안정성</label>
          <select id="incomeStability">
            <option value="stable">안정적</option>
            <option value="normal" selected>보통</option>
            <option value="volatile">변동 큼</option>
          </select>
          <div class="k"></div>
        </div>
        <div class="row"><label>만기 3개월 이내</label><input type="checkbox" id="maturitySoon"/><div class="k"></div></div>
        <div class="row"><label>중도해지/수수료 손실</label>
          <select id="penaltyRisk">
            <option value="none" selected>거의 없음</option>
            <option value="some">보통</option>
            <option value="high">손실 큼</option>
          </select>
          <div class="k"></div>
        </div>
        <div class="row"><label>6개월 내 큰 고정지출</label><input type="checkbox" id="bigExpense"/><div class="k"></div></div>
      </div>
      <div class="row"><label class="hint">권장 전환률(자동 계산)</label><input type="number" id="suggestedRate" readonly /><div class="k">%</div></div>
      <div class="btns"><button id="applySuggested" class="secondary">권장치 적용</button></div>

      <div class="hr"></div>
      <div class="row"><label class="result">BS-보정 합계 = 현금성(월) + 보존성(월) − 증가한 상환액(+일 때 차감)</label><input class="result" id="bsAdj" readonly /><div class="k result">만원/월</div></div>
      <div class="note">※ 성장성 자산은 원칙적으로 보정에 반영하지 않습니다.</div>
    </div>

    <!-- 최종 결과 -->
    <div class="card">
      <div class="section-title">최종 결과</div>
      <div class="row"><label class="result">최종 욕망 해소 자금(월) = F2S-흐름 + BS-보정</label><input class="result" id="finalF2S" readonly /><div class="k result">만원/월</div></div>
      <div id="message" class="note" style="margin-top:10px;"></div>
      <div class="btns" style="margin-top:14px;">
        <button id="save">로컬 저장</button>
        <button class="secondary" id="load">불러오기</button>
        <button class="secondary" id="reset">초기화</button>
        <button class="secondary" id="exportCsv">TSV 내보내기</button>
      </div>
      <div class="footer">※ 저장은 이 브라우저(로컬스토리지)에만 보관됩니다.</div>
    </div>

    <div class="footer">© DMP — Default Money Plan. 이 도구는 정보 제공 목적이며, 개인 상황에 따라 결과가 달라질 수 있습니다.</div>
  </div>

  <script>
    // ===== 유틸 =====
    const $ = (id) => document.getElementById(id);
    const num = (v) => (isFinite(parseFloat(v)) ? parseFloat(v) : 0);
    const round1 = (v) => (Math.round((v ?? 0) * 10) / 10).toFixed(1);
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // 입력 필드 ID
    const INPUT_IDS = [
      'income','rent','transport','food','telIns','others',
      'emFund','debtPay','futureSav',
      'cashAssets','emMonths','cashRate','spreadMonths',
      'preserveMature','preserveRate','preserveSpread','debtDelta'
    ];

    // 권장률 보조 입력
    const ADVISOR_IDS = ['earmark','incomeStability','maturitySoon','penaltyRisk','bigExpense'];

    // 결과 필드 ID
    const RESULT_IDS = [
      'mustSum','safetySum','flowF2S',
      'needEmergency','excessCash','cashAdj','preserveAdj','bsAdj',
      'finalF2S','suggestedRate'
    ];

    // 기본값
    const DEFAULTS = {
      income: 280, rent: 70, transport: 15, food: 50, telIns: 20, others: 25,
      emFund: 30, debtPay: 25, futureSav: 0,
      cashAssets: 800, emMonths: 6, cashRate: 50, spreadMonths: 12,
      preserveMature: 0, preserveRate: 25, preserveSpread: 6, debtDelta: 0,
      earmark: false, incomeStability: 'normal', maturitySoon: false, penaltyRisk: 'none', bigExpense: false
    };

    // 권장 전환률 계산
    function suggestPreserveRate(mustSum, cashAssets){
      let rate = 25; // 기본 25%

      // 비상자금 커버개월
      const coverage = mustSum > 0 ? cashAssets / mustSum : 0;

      // 체크리스트 조정
      if ($('earmark').checked) rate -= 15;                 // 목적자금: 크게 낮춤(≈10%대)
      if (coverage < 3) rate -= 10;                          // 비상자금 부족
      else if (coverage >= 6) rate += 10;                    // 여유

      const st = $('incomeStability').value;
      if (st === 'stable') rate += 5;
      else if (st === 'volatile') rate -= 10;

      if ($('maturitySoon').checked) rate += 5;              // 3개월 내 만기

      const risk = $('penaltyRisk').value;
      if (risk === 'some') rate -= 5;
      else if (risk === 'high') rate -= 12;

      if ($('bigExpense').checked) rate -= 5;                // 6개월 내 큰 지출

      rate = Math.round(clamp(rate, 0, 50));                 // 0~50% 캡
      $('suggestedRate').value = rate.toString();
      return rate;
    }

    // 메인 계산
    function calc() {
      const income = num($('income').value);

      const mustSum = num($('rent').value) + num($('transport').value) + num($('food').value) + num($('telIns').value) + num($('others').value);
      $('mustSum').value = round1(mustSum);

      const safetySum = num($('emFund').value) + num($('debtPay').value) + num($('futureSav').value);
      $('safetySum').value = round1(safetySum);

      const flowF2S = income - (mustSum + safetySum);
      $('flowF2S').value = round1(flowF2S);

      // 현금성 보정
      const cashAssets = num($('cashAssets').value);
      const emMonths = clamp(num($('emMonths').value), 3, 12);
      $('emMonths').value = emMonths;

      const needEmergency = mustSum * emMonths;
      $('needEmergency').value = round1(needEmergency);

      const excess = Math.max(0, cashAssets - needEmergency);
      $('excessCash').value = round1(excess);

      const cashRate = clamp(num($('cashRate').value), 0, 100);
      $('cashRate').value = cashRate;
      const spreadMonths = clamp(num($('spreadMonths').value), 6, 24);
      $('spreadMonths').value = spreadMonths;

      const cashAdj = (excess * (cashRate / 100)) / (spreadMonths || 1);
      $('cashAdj').value = round1(cashAdj);

      // 보존성 보정
      const preserveMature = num($('preserveMature').value);
      const preserveRate = clamp(num($('preserveRate').value), 0, 100);
      $('preserveRate').value = preserveRate;
      const preserveSpread = clamp(num($('preserveSpread').value), 3, 24);
      $('preserveSpread').value = preserveSpread;

      const preserveAdj = (preserveMature * (preserveRate / 100)) / (preserveSpread || 1);
      $('preserveAdj').value = round1(preserveAdj);

      // 권장 전환률 갱신
      suggestPreserveRate(mustSum, cashAssets);

      // 부채 보정
      const debtDelta = num($('debtDelta').value);
      const bsAdj = cashAdj + preserveAdj - Math.max(0, debtDelta) + Math.min(0, debtDelta);
      $('bsAdj').value = round1(bsAdj);

      // 최종
      const final = flowF2S + bsAdj;
      $('finalF2S').value = round1(final);

      renderMessage({ excess, preserveMature, preserveRate, debtDelta });
    }

    function renderMessage({ excess, preserveMature, preserveRate, debtDelta }) {
      const el = $('message');
      if (!el) return;

      const msg = [];
      if (excess <= 0) msg.push('현금성 자산이 비상자금 목표에 미달하여 현금성 보정 가산이 없습니다.');
      if (preserveMature > 0 && preserveRate > 0) msg.push('보존성 만기금 일부를 기간에 나눠 반영 중입니다.');
      if (debtDelta !== 0) msg.push(`부채 스케줄 변화로 월 ${Math.abs(debtDelta).toFixed(1)}만 원 ${debtDelta > 0 ? '추가 상환(차감)' : '감소(가산)'} 반영.`);
      if (msg.length === 0) msg.push('계산이 완료되었습니다. 결과는 만 원 단위로 반올림 표시됩니다.');
      el.textContent = msg.join(' ');
    }

    // 저장/불러오기/초기화 (보조입력 포함 저장)
    function saveLocal() {
      const ids = [...INPUT_IDS, ...ADVISOR_IDS, ...RESULT_IDS];
      const data = {};
      ids.forEach((id) => {
        const el = $(id);
        if (!el) return;
        data[id] = (el.type === 'checkbox') ? el.checked : el.value;
      });
      localStorage.setItem('dmp_f2s', JSON.stringify(data));
      alert('이 브라우저에 저장했습니다.');
    }

    function loadLocal() {
      const raw = localStorage.getItem('dmp_f2s');
      if (!raw) { alert('저장된 데이터가 없습니다.'); return; }
      const data = JSON.parse(raw);
      Object.keys(data).forEach((id) => {
        const el = $(id);
        if (!el) return;
        if (el.type === 'checkbox') el.checked = !!data[id];
        else el.value = data[id];
      });
      calc();
      alert('불러오기 완료.');
    }

    function resetAll() {
      if (!confirm('모든 값을 초기화할까요?')) return;
      localStorage.removeItem('dmp_f2s');
      // 입력/보조 입력 초기화
      [...INPUT_IDS, ...ADVISOR_IDS].forEach((id) => {
        const el = $(id);
        if (!el) return;
        if (el.type === 'checkbox') el.checked = !!DEFAULTS[id];
        else if (DEFAULTS[id] != null) el.value = DEFAULTS[id];
        else el.value = '';
      });
      calc();
    }

    // TSV(UTF-16LE+BOM) 내보내기 — 한글 깨짐 방지
    function toUTF16LEWithBOM(str){
      const bom = new Uint8Array([0xFF, 0xFE]);
      const buf = new Uint8Array(str.length * 2);
      for (let i = 0; i < str.length; i++) {
        const code = str.charCodeAt(i);
        buf[i*2]   = code & 0xFF;
        buf[i*2+1] = (code >> 8) & 0xFF;
      }
      const out = new Uint8Array(bom.length + buf.length);
      out.set(bom, 0); out.set(buf, bom.length);
      return out;
    }
    function exportTSV() {
      const rows = [
        ['항목','값(만원/또는 단위)'],
        ['세후 소득', $('income').value],
        ['필수 합계', $('mustSum').value],
        ['안전망 합계', $('safetySum').value],
        ['F2S-흐름', $('flowF2S').value],
        ['현금성 자산', $('cashAssets').value],
        ['비상자금 목표(개월)', $('emMonths').value],
        ['적정 비상자금', $('needEmergency').value],
        ['초과 현금성', $('excessCash').value],
        ['현금성 보정(월)', $('cashAdj').value],
        ['보존성 만기(6개월내)', $('preserveMature').value],
        ['보존성 전환율(%)', $('preserveRate').value],
        ['보존성 분할기간(개월)', $('preserveSpread').value],
        ['보존성 보정(월)', $('preserveAdj').value],
        ['부채 변화(월)', $('debtDelta').value],
        ['권장 전환률(%)', $('suggestedRate').value],
        ['BS-보정 합계(월)', $('bsAdj').value],
        ['최종 F2S(월)', $('finalF2S').value],
      ];
      const tsv = rows.map(r => r.join('\t')).join('\r\n');
      const bytes = toUTF16LEWithBOM(tsv);
      const blob = new Blob([bytes], { type: 'text/tab-separated-values;charset=utf-16le;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dmp_f2s_worksheet.tsv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // 초기화
    window.addEventListener('DOMContentLoaded', () => {
      // 기본값 적용
      Object.entries(DEFAULTS).forEach(([id,v])=>{
        const el=$(id); if(!el) return;
        if(el.type==='checkbox') el.checked=!!v; else el.value=v;
      });

      // 이벤트 바인딩
      [...INPUT_IDS, ...ADVISOR_IDS].forEach((id) => $(id)?.addEventListener('input', calc));
      $('save')?.addEventListener('click', saveLocal);
      $('load')?.addEventListener('click', loadLocal);
      $('reset')?.addEventListener('click', resetAll);
      $('exportCsv')?.addEventListener('click', exportTSV);
      $('applySuggested')?.addEventListener('click', () => {
        const v = $('suggestedRate').value;
        $('preserveRate').value = v;
        calc();
      });

      calc();
    });
  </script>
</body>
</html>
